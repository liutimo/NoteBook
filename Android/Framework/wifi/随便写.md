# 加载wifi驱动
`WifiNative::loadDriverNative`

​	`wifi_load_driver`            === > `hardware/libhardware_legacy/wifi/wifi.c`





## 如何找到需要加载的驱动

在`/system/lib/moudles`目录下，存放着wifi芯片的驱动程序。

![1577783570219](images/1577783570219.png)



RK3399 中，wifi芯片通过USB总线连接到CPU。该函数会通过遍历`/sys/bus/usb/devices`下所有device的`uevent`节点来获取设备信息。

以`rtl8723bu`(vid = 0x0bda  pid =0xb720)为例:

![1577784721455](images/1577784721455.png)

通过读取`PRODUCT=`行来获取USB设备的 Vendor ID 和 Product ID。

`hardware/libhardware_legacy/wifi/rk_wifi_ctrl.c`

```c++
int get_wifi_device_id(const char *bus_dir, const char *prefix);
```

该函数负责找到系统当前可用的wifi chip名称。拿到名称后，就知道加载哪个驱动了。



## 安装驱动

直接show code，通过系统调用`__NR_finit_module`来完成驱动加载。

```c++
static int insmod(const char *filename, const char *options)
{
    int fd = open(filename, O_RDONLY | O_NOFOLLOW | O_CLOEXEC);
    if (fd == -1) {
        ALOGE("insmod: open(\"%s\") failed: %s", filename, strerror(errno));
        return -1;
    }
    int rc = syscall(__NR_finit_module, fd, options, 0);
    if (rc == -1) {
        ALOGE("finit_module for \"%s\" failed: %s", filename, strerror(errno));
    }
    close(fd);
    return rc;
}
```



驱动安装完后，调用`check_wireless_ready`检查网络状态。超时时间为20s。

> 内核4.4 	读取  /proc/net/dev 节点
>
> 内核3.10   读取 /proc/net/wireless 节点
>
> 通过判断节点是否包含 wlan0 或者 p2p0来判断驱动是否加载成功。

